services:
  caddy:
    image: caddy:2
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    env_file: .env
    depends_on:
      - lobby
    networks:
      lobby_net:
        ipv4_address: 172.30.0.10

  lobby:
    image: ghcr.io/frisksitron/lobby/server:${LOBBY_IMAGE_TAG:?LOBBY_IMAGE_TAG is required}
    restart: unless-stopped
    ports:
      - "${LOBBY_SFU_MIN_PORT:-50000}-${LOBBY_SFU_MAX_PORT:-50100}:${LOBBY_SFU_MIN_PORT:-50000}-${LOBBY_SFU_MAX_PORT:-50100}/udp"
    env_file: .env
    environment:
      LOBBY_DATABASE_PATH: /data/lobby.db
      LOBBY_BLOB_ROOT: ${LOBBY_BLOB_ROOT:-/data/blobs}
      LOBBY_UPLOAD_MAX_BYTES: ${LOBBY_UPLOAD_MAX_BYTES:-10485760}
      LOBBY_TRUSTED_PROXY_CIDRS: 172.30.0.10/32
    volumes:
      - lobby-data:/data
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      lobby_net:
        ipv4_address: 172.30.0.20

  coturn:
    image: coturn/coturn
    restart: unless-stopped
    ports:
      - "3478:3478"
      - "3478:3478/udp"
      - "49152-49252:49152-49252/udp"
    command: >-
      -n
      --listening-port=3478
      --min-port=49152
      --max-port=49252
      --use-auth-secret
      --static-auth-secret=${LOBBY_TURN_SECRET}
      --realm=${LOBBY_DOMAIN}
      --external-ip=${LOBBY_SFU_PUBLIC_IP}
      --no-tls
      --no-dtls
      --log-file=stdout
    env_file: .env
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  lobby-data:
  caddy-data:
  caddy-config:

networks:
  lobby_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24
