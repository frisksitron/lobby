#cloud-config
#
# Lobby server — Hetzner Cloud cloud-init template
#
# Fill in the <...> placeholders below, then paste this entire file
# into the "Cloud config" field when creating a Hetzner Cloud server.
#
# What this does:
#   - Creates a non-root 'lobby' user (SSH key only)
#   - Hardens SSH, enables fail2ban and UFW
#   - Installs Docker and starts the Lobby stack
#   - Auto-generates unique JWT and TURN secrets
#   - Auto-detects the server's public IP via Hetzner metadata

users:
  - name: lobby
    groups: users, admin, docker
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - <public_ssh_key>    # EDIT: your SSH public key

groups:
  - docker

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose-v2
  - unattended-upgrades
  - fail2ban
  - ufw

write_files:
  # SSH hardening
  - path: /etc/ssh/sshd_config.d/hardening.conf
    content: |
      PermitRootLogin no
      PasswordAuthentication no
      KbdInteractiveAuthentication no
      MaxAuthTries 3
      AllowUsers lobby

  # Lobby .env — EDIT the <...> placeholders before use
  - path: /opt/lobby/.env
    content: |
      LOBBY_DOMAIN=<your-domain>
      LOBBY_SFU_PUBLIC_IP=auto
      LOBBY_SERVER_NAME=Lobby Server
      LOBBY_SERVER_BASE_URL=https://<your-domain>
      LOBBY_JWT_SECRET=auto
      LOBBY_SMTP_HOST=<smtp-host>
      LOBBY_SMTP_PORT=<smtp-port>
      LOBBY_SMTP_FROM=<smtp-from>
      LOBBY_SMTP_USERNAME=<smtp-username>
      LOBBY_SMTP_PASSWORD=<smtp-password>
      LOBBY_TURN_SECRET=auto
      LOBBY_TURN_ADDR=<your-domain>:3478

  # Caddyfile
  - path: /opt/lobby/Caddyfile
    content: |
      {$LOBBY_DOMAIN} {
        reverse_proxy lobby:8080
      }

runcmd:
  # Generate unique secrets
  - 'sed -i "0,/^LOBBY_JWT_SECRET=auto/{s/^LOBBY_JWT_SECRET=auto/LOBBY_JWT_SECRET=$(openssl rand -hex 32)/}" /opt/lobby/.env'
  - 'sed -i "0,/^LOBBY_TURN_SECRET=auto/{s/^LOBBY_TURN_SECRET=auto/LOBBY_TURN_SECRET=$(openssl rand -hex 32)/}" /opt/lobby/.env'

  # Auto-detect public IP via Hetzner metadata
  - 'sed -i "s/^LOBBY_SFU_PUBLIC_IP=auto/LOBBY_SFU_PUBLIC_IP=$(curl -s http://169.254.169.254/hetzner/v1/metadata/public-ipv4)/" /opt/lobby/.env'

  # Download compose file from repo
  - curl -fsSL -o /opt/lobby/docker-compose.prod.yml https://raw.githubusercontent.com/frisksitron/lobby/main/src-server/docker-compose.prod.yml

  # Firewall
  - ufw allow OpenSSH
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow 443/udp
  - ufw allow 3478
  - ufw allow 49152:49252/udp
  - ufw allow 50000:50100/udp
  - ufw --force enable

  # fail2ban
  - systemctl enable fail2ban

  # Start Lobby
  - cd /opt/lobby && docker compose -f docker-compose.prod.yml up -d

final_message: "Lobby server is ready after $UPTIME seconds"
